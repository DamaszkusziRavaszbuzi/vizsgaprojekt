<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Word Statistics</title>
    <link rel="stylesheet" href="../static/styles/global.css" />
    <!-- Paste into the <head> of your base template (or each page). It uses two strategies:
     - For logged-in users, the server injects {{ theme }} and we point the <link> to it.
     - For visitors, an inline script checks localStorage and sets the href before the CSS loads
-->
    <!-- inline script to choose theme early (avoid FOUC) -->
    <script>
      (function () {
        // server-side injected theme (for logged in users) is rendered into this placeholder
        // We'll check localStorage first for unauthenticated users
        try {
          var stored = localStorage.getItem("theme");
          if (stored) {
            // by setting window.__preferredTheme we can later use it in the <link> below
            window.__preferredTheme = stored;
          } else {
            // if server injected theme exists it'll be set by template variable below
            window.__preferredTheme = null;
          }
        } catch (e) {
          window.__preferredTheme = null;
        }
      })();
    </script>

    <!-- Theme stylesheet link (has id so JS can swap it instantly) -->
    <link
      id="themeStylesheet"
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/themes/' + (theme or 'themeDark') + '.css') }}" />
    <style>
      .content {
        margin-left: 15%;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .stats-table {
        width: 90%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: var(--Sbackground);
        border: 2px solid var(--outline);
      }

      .stats-table th,
      .stats-table td {
        padding: 12px;
        text-align: left;
        border: 1px solid var(--outline);
        color: var(--text);
      }

      .stats-table th {
        background-color: var(--Cbackground);
        color: var(--HighlightText);
      }

      .stats-table tr:hover {
        background-color: var(--Cbackground);
      }

      .confidence-positive {
        color: rgb(0, 255, 0);
      }

      .confidence-negative {
        color: var(--error);
      }

      .confidence-neutral {
        color: var(--text);
      }

      .sort-button {
        background: none;
        border: none;
        color: var(--HighlightText);
        cursor: pointer;
        padding: 0 5px;
      }

      .sort-button:hover {
        color: var(--white);
      }

      .stats-summary {
        background-color: var(--Sbackground);
        border: 2px solid var(--outline);
        padding: 20px;
        margin-bottom: 20px;
        color: var(--text);
        width: 90%;
      }

      .stats-summary h2 {
        color: var(--HighlightText);
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <div class="sidenav">
      <a href="{{url_for('routeToIndex')}}">Főoldal</a>
      <a href="{{url_for('routeToEdit')}}">Szavak kezelése</a>
      <a href="{{url_for('routeToSettings')}}">Beálltások</a>
      <a href="{{url_for('routeToStatistics')}}">Statisztika</a>
      <a href="{{url_for('logout')}}">Kijelentkezés</a>
    </div>

    <div class="content">
      <h1>Statisztika</h1>

      <div class="stats-summary" id="summary">
        <h2>Összegzés</h2>
        <p>Összes szó: <span id="totalWords">0</span></p>
        <p>Átlagos magabiztosság: <span id="avgConfidence">0</span></p>
        <p>Ismert szavak: <span id="positiveWords">0</span></p>
        <p>Gyakorlásra szoruló szavak: <span id="negativeWords">0</span></p>
      </div>

      <table class="stats-table">
        <thead>
          <tr>
            <th>Szó <button class="sort-button" data-sort="word">↕</button></th>
            <th>
              Fordítás
              <button class="sort-button" data-sort="translation">↕</button>
            </th>
            <th>
              Siker <button class="sort-button" data-sort="pass">↕</button>
            </th>
            <th>
              Siker Segítséggel
              <button class="sort-button" data-sort="passWithHelp">↕</button>
            </th>
            <th>
              Sikertelen <button class="sort-button" data-sort="fail">↕</button>
            </th>
            <th>
              Sikertelen Segítséggel
              <button class="sort-button" data-sort="failWithHelp">↕</button>
            </th>
            <th>
              Magabiztosság
              <button class="sort-button" data-sort="confidenceIndex">↕</button>
            </th>
          </tr>
        </thead>
        <tbody id="statsBody">
          <!-- Data will be populated here -->
        </tbody>
      </table>
    </div>

    <script>
      let words = [];
      let currentSort = { column: "word", ascending: true };

      function updateSummary() {
        const totalWords = words.length;
        const avgConfidence =
          words.reduce((acc, word) => acc + word.confidenceIndex, 0) /
          totalWords;
        const positiveWords = words.filter(
          (word) => word.confidenceIndex > 0
        ).length;
        const negativeWords = words.filter(
          (word) => word.confidenceIndex < 0
        ).length;

        document.getElementById("totalWords").textContent = totalWords;
        document.getElementById("avgConfidence").textContent =
          avgConfidence.toFixed(2);
        document.getElementById("positiveWords").textContent = positiveWords;
        document.getElementById("negativeWords").textContent = negativeWords;
      }

      function getConfidenceClass(confidence) {
        if (confidence > 0) return "confidence-positive";
        if (confidence < 0) return "confidence-negative";
        return "confidence-neutral";
      }

      function sortWords(column) {
        if (currentSort.column === column) {
          currentSort.ascending = !currentSort.ascending;
        } else {
          currentSort.column = column;
          currentSort.ascending = true;
        }

        words.sort((a, b) => {
          let comparison = 0;
          if (typeof a[column] === "string") {
            comparison = a[column].localeCompare(b[column]);
          } else {
            comparison = a[column] - b[column];
          }
          return currentSort.ascending ? comparison : -comparison;
        });

        displayWords();
      }

      function displayWords() {
        const tbody = document.getElementById("statsBody");
        tbody.innerHTML = "";

        words.forEach((word) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${word.word}</td>
                    <td>${word.translation}</td>
                    <td>${word.pass}</td>
                    <td>${word.passWithHelp}</td>
                    <td>${word.fail}</td>
                    <td>${word.failWithHelp}</td>
                    <td class="${getConfidenceClass(word.confidenceIndex)}">${
            word.confidenceIndex
          }</td>
                `;
          tbody.appendChild(row);
        });
      }

      function loadStatistics() {
        fetch("/get_word_statistics")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              words = data.words;
              updateSummary();
              displayWords();
            }
          });
      }

      // Add event listeners for sorting
      document.querySelectorAll(".sort-button").forEach((button) => {
        button.addEventListener("click", (e) => {
          const column = e.target.getAttribute("data-sort");
          sortWords(column);
        });
      });

      // Load statistics when the page loads
      document.addEventListener("DOMContentLoaded", loadStatistics);
    </script>
    <script src="../static/js/themeChange.js"></script>
  </body>
</html>
